
@page "/editproduct/{prodId:int}"  

@inject IEditProductUseCase EditProductUseCase 
@inject IViewCategoriesByNameUseCase ViewCategoriesByNameUseCase 
@inject IViewProductByIdUseCase ViewProductIdUseCase
@inject NavigationManager NavigationManager

<h3>Product Edit</h3>
<br/>
<EditForm model ="product" OnValidSubmit="SaveProduct">
	<DataAnnotationsValidator></DataAnnotationsValidator>
	<ValidationSummary></ValidationSummary>

	<div class="form-group">
		<label for="name">Product Name</label>
		<InputText id="name"
			@bind-Value="product.Name"
			class="form-control">
		</InputText>
	</div>
	<div class="form-group">
		<label for="description">Description</label>
		<InputText id="description"
			@bind-Value="product.Description"
			class="form-control">
		</InputText>
	</div>
	<div class="form-group">
		<label for="price">Price</label>
		<InputNumber id="price"
			@bind-Value="product.Price"
			class="form-control">
		</InputNumber>
	</div>
		<div class="form-group">
		<label for="Category">Category</label>
		<InputSelect id="name"
			@bind-Value="product.CategoryId"
			class="form-control">
			@foreach (var category in categories)
			{
			  <option value="@category.Id">@category.Name</option>
			}
		</InputSelect>
	</div>
	<div class="form-group">
		<label for="image">Images</label>
		<div>
			<img src="@product.Image" style="width:250px; height: 250px;"/>
		</div>
		<InputFile OnChange="@OnInputFileChange" class="form-control"></InputFile>
	</div>
	<br/>
	<button type="submit" class="btn btn-primary">Save</button>
	<button type="button" class="btn btn-primary" @onclick="OnCancel">Cancel</button>
</EditForm>

@code {
	[Parameter]
	public int ProdId{ get; set; }

	private Product product = new Product();
	private List<Category> categories = new List<Category>();

	protected override async Task OnParametersSetAsync()
	{
		this.product = await ViewProductIdUseCase.ExcuteAsync(this.ProdId);
		this.categories = (await ViewCategoriesByNameUseCase.ExcuteAsync("")).ToList();
	}
	public async Task SaveProduct()
	{
		await EditProductUseCase.ExcuteAsync(this.product);
		NavigationManager.NavigateTo("/products");
	}
	private void OnCancel()
	{
		NavigationManager.NavigateTo("/products");
	}
    private async Task OnInputFileChange(InputFileChangeEventArgs inputFileChangeEventArgs)
	{
		var fileFormat = "image/png";
		// get file
		var imageFile = await inputFileChangeEventArgs.File.RequestImageFileAsync(fileFormat, 1920, 1920);
		// convert file into a byte array
		var buffer = new byte[imageFile.Size];
		await imageFile.OpenReadStream().ReadAsync(buffer);
		// convert byte array into a base 64 string
		string imageDataUrl = $"data:{fileFormat};base64,{Convert.ToBase64String(buffer)}";
		product.Image = imageDataUrl;
	}
}
